sudo: required
dist: bionic
language: csharp
mono: none
dotnet: 3.1.402
solution: Covid19Api.sln
env:
  global:
    - DocumentDbContextOptions__ConnectionString="mongodb://${MONGODB_USERNAME}:${MONGODB_PASSWORD}@localhost:27017"
    - DocumentDbContextOptions__DatabaseName="Etdb_UserService_Dev_Testing"
    - RedisCacheOptions__Configuration="${RedisConnection}"
    - RedisCacheOptions__InstanceName="Etdb_UserService_Travis"
    - ASPNETCORE__ENVIRONMENT="CI"
stages:
  - build
  - publish
  - deploy
jobs:
  include:
    - stage: build
      name: build
      if: tag IS NOT present
      script:
        - dotnet build
    - stage: publish
      name: publish
      if: tag IS present
      services:
        - docker
      before_script:
        - docker login -u ${REGISTRY_USER} -p ${REGISTRY_PASSWORD} ${REGISTRY}
      script:
        - ./publish-docker.sh
    - stage: deploy
      name: deploy
      if: tag IS present
      addons:
        apt:
          update: true
      before_script:
        - curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
      script:
        - ./deploy-app.sh
